<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Metadata Search Engine</title>
<style>
  body { font-family: Arial, sans-serif; margin: 2rem; background: #f9f9f9; }
  h1 { text-align: center; }
  form { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 2rem; justify-content: center; }
  input, select, button { padding: 0.5rem; font-size: 1rem; }
  button { cursor: pointer; }
  #results { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; }
  section { background: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 1rem; width: 300px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  section img, section audio, section video, section iframe { max-width: 100%; border-radius: 6px; margin-top: 10px; }
  section p { margin: 0.3rem 0; font-size: 0.95rem; }
  section pre { white-space: pre-wrap; font-size: 0.85rem; background: #f0f0f0; padding: 0.5rem; border-radius: 4px; }
  section a { display: inline-block; margin-top: 0.5rem; text-decoration: none; padding: 0.4rem 0.6rem; border-radius: 4px; color: #fff; font-size: 0.9rem; }
  .download { background-color: #28a745; }
</style>
</head>
<body>
<h1>üîç Metadata Search Engine</h1>

<form id="searchForm">
  <input type="text" id="filename" placeholder="Filename (exact)">
  <input type="text" id="key" placeholder="Metadata Key">
  <input type="text" id="value" placeholder="Metadata Value">
  <select id="operator">
    <option value="=">=</option>
    <option value="!=">!=</option>
    <option value=">">&gt;</option>
    <option value="<">&lt;</option>
  </select>
  <select id="filetype">
    <option value="">Any type</option>
    <option value="pdf">PDF</option>
    <option value="docx">DOCX</option>
    <option value="image">Image</option>
    <option value="audio">Audio</option>
    <option value="video">Video</option>
  </select>
  <input type="number" id="lat" placeholder="Latitude" step="0.000001">
  <input type="number" id="lng" placeholder="Longitude" step="0.000001">
  <input type="number" id="radius" placeholder="Radius (km)" step="0.1">
  <button type="submit">Search</button>
</form>

<div id="results"></div>

<script>
const form = document.getElementById("searchForm");
const resultsDiv = document.getElementById("results");

form.addEventListener("submit", async e => {
  e.preventDefault();

  const filename = document.getElementById("filename").value.trim();
  const key = document.getElementById("key").value.trim();
  const value = document.getElementById("value").value.trim();
  const operator = document.getElementById("operator").value;
  const filetype = document.getElementById("filetype").value;
  const lat = document.getElementById("lat").value;
  const lng = document.getElementById("lng").value;
  const radius = document.getElementById("radius").value;

  if (!filename && !key && !value && !lat && !lng) {
    resultsDiv.innerHTML = "<p>Enter at least one search term</p>";
    return;
  }

  try {
    const params = new URLSearchParams({ filename, key, value, operator, filetype, lat, lng, radius });
    const res = await fetch(`/api/search?${params.toString()}`);
    if (!res.ok) throw new Error("Network response was not ok");
    const data = await res.json();
    displayResults(data.results);
  } catch (err) {
    resultsDiv.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
  }
});

function displayResults(results) {
  if (!results || results.length === 0) {
    resultsDiv.innerHTML = "<p>No results found.</p>";
    return;
  }

  const html = results.map(f => {
    const encodedFile = encodeURIComponent(f.filename);
    let media = "";

    if (f.filetype === "image") media = `<img src="/files/${encodedFile}" alt="${f.filename}">`;
    else if (f.filetype === "audio") media = `<audio controls src="/files/${encodedFile}"></audio>`;
    else if (f.filetype === "video") media = `<video controls src="/files/${encodedFile}"></video>`;
    else if (f.filetype === "pdf") media = `<iframe src="/files/${encodedFile}" style="width:100%; height:400px;" frameborder="0"></iframe>`;
    else if (f.filetype === "docx") {
      const url = encodeURIComponent(`${window.location.origin}/files/${f.filename}`);
      media = `<iframe src="https://docs.google.com/gview?url=${url}&embedded=true" style="width:100%; height:400px;" frameborder="0"></iframe>`;
    }

    const metadataHtml = Array.isArray(f.metadata) && f.metadata.length > 0
      ? f.metadata.map(m => `<p><b>${m.key}</b>: <pre>${m.value}</pre></p>`).join('')
      : '<p>No metadata available</p>';

    return `
      <section>
        <h2>${f.filename} (${f.filetype})</h2>
        ${metadataHtml}
        <p><b>Relevance:</b> ${f.relevance}</p>
        ${media}
        <a href="/download/${encodedFile}" download class="download">‚¨áÔ∏è Download</a>
      </section>
    `;
  }).join("");

  resultsDiv.innerHTML = html;
}
</script>
</body>
</html>

